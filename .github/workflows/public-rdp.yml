name: Public RDP (Anyone Can Connect)

on:
  workflow_dispatch:

jobs:
  public-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure RDP Settings
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Allow RDP through firewall
          netsh advfirewall firewall add rule name="RDP-Public" `
            dir=in action=allow protocol=TCP localport=3389

          # Restart RDP service
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Static Password
        run: |
          # Use static credentials from GitHub Secrets or defaults
          $username = "${{ secrets.RDP_USERNAME }}"
          $password = "${{ secrets.RDP_PASSWORD }}"
          
          # Use defaults if secrets are not set
          if ([string]::IsNullOrEmpty($username)) {
              $username = "RDP"
          }
          if ([string]::IsNullOrEmpty($password)) {
              $password = "RDP@2026!Secure"
          }
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Setup ngrok Tunnel
        run: |
          # Download ngrok
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" `
            -OutFile "$env:TEMP\ngrok.zip"
          Expand-Archive -Path "$env:TEMP\ngrok.zip" -DestinationPath "$env:TEMP\ngrok"
          
          # Configure ngrok with auth token (add NGROK_AUTH_TOKEN to GitHub Secrets)
          $ngrokToken = "${{ secrets.NGROK_AUTH_TOKEN }}"
          if (-not [string]::IsNullOrEmpty($ngrokToken)) {
              & "$env:TEMP\ngrok\ngrok.exe" config add-authtoken $ngrokToken
          }
          
          # Start ngrok tunnel for RDP (port 3389)
          Start-Process -FilePath "$env:TEMP\ngrok\ngrok.exe" `
            -ArgumentList "tcp", "3389", "--log=stdout" `
            -RedirectStandardOutput "$env:TEMP\ngrok.log" `
            -NoNewWindow
          
          # Wait for ngrok to start
          Start-Sleep -Seconds 10
          
          # Get public URL from ngrok API
          $ngrokApi = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
          $publicUrl = $ngrokApi.tunnels[0].public_url
          
          # Extract host and port
          $publicUrl -match "tcp://(.+):(\d+)"
          $ngrokHost = $Matches[1]
          $ngrokPort = $Matches[2]
          
          echo "NGROK_HOST=$ngrokHost" >> $env:GITHUB_ENV
          echo "NGROK_PORT=$ngrokPort" >> $env:GITHUB_ENV

      - name: Display Connection Info
        run: |
          Write-Host "`n"
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host "   PUBLIC RDP SERVER IS READY!" -ForegroundColor Green
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üåç ANYONE CAN CONNECT WITH THESE DETAILS:" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "  Address:  $env:NGROK_HOST" -ForegroundColor Yellow
          Write-Host "  Port:     $env:NGROK_PORT" -ForegroundColor Yellow
          Write-Host "  Username: $env:RDP_USER" -ForegroundColor Yellow
          Write-Host "  Password: $env:RDP_PASS" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host ""
          
          Write-Host "üìã ONE-LINE CONNECTION COMMANDS:" -ForegroundColor Magenta
          Write-Host ""
          Write-Host "PowerShell:" -ForegroundColor Yellow
          Write-Host "  cmdkey /generic:$env:NGROK_HOST`:$env:NGROK_PORT /user:$env:RDP_USER /pass:$env:RDP_PASS; mstsc /v:$env:NGROK_HOST`:$env:NGROK_PORT" -ForegroundColor White -BackgroundColor DarkBlue
          Write-Host ""
          Write-Host "CMD:" -ForegroundColor Yellow
          Write-Host "  cmdkey /generic:$env:NGROK_HOST`:$env:NGROK_PORT /user:$env:RDP_USER /pass:$env:RDP_PASS & mstsc /v:$env:NGROK_HOST`:$env:NGROK_PORT" -ForegroundColor White -BackgroundColor DarkGreen
          Write-Host ""
          Write-Host "This command will:" -ForegroundColor Gray
          Write-Host "  1. Save the RDP credentials" -ForegroundColor Gray
          Write-Host "  2. Automatically open RDP connection" -ForegroundColor Gray
          Write-Host "  3. Connect without asking for password" -ForegroundColor Gray
          Write-Host ""
          Write-Host "=========================================" -ForegroundColor Magenta
          Write-Host ""
          
          # Keep runner active
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Server Active - Public URL: tcp://$env:NGROK_HOST`:$env:NGROK_PORT"
              Start-Sleep -Seconds 300
          }
