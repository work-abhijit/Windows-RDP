name: RDP-Diagnostic

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Check Secrets
        run: |
          Write-Host "`nüîç Checking GitHub Secrets..." -ForegroundColor Cyan
          
          $issues = @()
          
          # Check TAILSCALE_AUTH_KEY
          if ([string]::IsNullOrWhiteSpace("${{ secrets.TAILSCALE_AUTH_KEY }}")) {
              $issues += "‚ùå TAILSCALE_AUTH_KEY is not set"
          } else {
              Write-Host "‚úÖ TAILSCALE_AUTH_KEY is set" -ForegroundColor Green
          }
          
          # Check RDP_USERNAME
          if ([string]::IsNullOrWhiteSpace("${{ secrets.RDP_USERNAME }}")) {
              $issues += "‚ö†Ô∏è  RDP_USERNAME is not set (will use default)"
          } else {
              Write-Host "‚úÖ RDP_USERNAME is set: ${{ secrets.RDP_USERNAME }}" -ForegroundColor Green
          }
          
          # Check RDP_PASSWORD
          if ([string]::IsNullOrWhiteSpace("${{ secrets.RDP_PASSWORD }}")) {
              $issues += "‚ö†Ô∏è  RDP_PASSWORD is not set (will use default)"
          } else {
              Write-Host "‚úÖ RDP_PASSWORD is set" -ForegroundColor Green
          }
          
          if ($issues.Count -gt 0) {
              Write-Host "`n‚ö†Ô∏è  Issues found:" -ForegroundColor Yellow
              $issues | ForEach-Object { Write-Host "   $_" -ForegroundColor Yellow }
              
              if ($issues -match "TAILSCALE_AUTH_KEY") {
                  Write-Host "`n‚ùå CRITICAL: TAILSCALE_AUTH_KEY is required!" -ForegroundColor Red
                  Write-Host "   Go to: https://login.tailscale.com/admin/settings/keys" -ForegroundColor Gray
                  Write-Host "   Generate an auth key and add it to GitHub Secrets" -ForegroundColor Gray
                  exit 1
              }
          } else {
              Write-Host "`n‚úÖ All secrets configured correctly!" -ForegroundColor Green
          }

      - name: Test Network Connectivity
        run: |
          Write-Host "`nüåê Testing network connectivity..." -ForegroundColor Cyan
          
          $testUrls = @(
              "https://api.ipify.org",
              "https://pkgs.tailscale.com",
              "https://login.tailscale.com"
          )
          
          foreach ($url in $testUrls) {
              try {
                  $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                  Write-Host "‚úÖ $url - OK (Status: $($response.StatusCode))" -ForegroundColor Green
              } catch {
                  Write-Host "‚ùå $url - FAILED: $_" -ForegroundColor Red
              }
          }

      - name: Test Tailscale Installation
        run: |
          Write-Host "`nüì• Testing Tailscale installation..." -ForegroundColor Cyan
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale-test.msi"
          
          try {
              Write-Host "Downloading Tailscale..." -ForegroundColor Yellow
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
              
              $fileSize = (Get-Item $installerPath).Length / 1MB
              Write-Host "‚úÖ Downloaded: $([math]::Round($fileSize, 2)) MB" -ForegroundColor Green
              
              Write-Host "Installing Tailscale..." -ForegroundColor Yellow
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
              
              Start-Sleep -Seconds 5
              
              $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
              if (Test-Path $tailscalePath) {
                  Write-Host "‚úÖ Tailscale installed successfully" -ForegroundColor Green
                  
                  $version = & $tailscalePath version
                  Write-Host "   Version: $version" -ForegroundColor Gray
              } else {
                  Write-Host "‚ùå Tailscale executable not found at $tailscalePath" -ForegroundColor Red
                  exit 1
              }
              
          } catch {
              Write-Host "‚ùå Installation failed: $_" -ForegroundColor Red
              exit 1
          }

      - name: Test Tailscale Connection
        run: |
          Write-Host "`nüîó Testing Tailscale connection..." -ForegroundColor Cyan
          
          $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          
          try {
              Write-Host "Connecting to Tailscale..." -ForegroundColor Yellow
              $output = & $tailscalePath up --authkey=$authKey --hostname="gh-diagnostic-$env:GITHUB_RUN_ID" 2>&1
              Write-Host "Output: $output" -ForegroundColor Gray
              
              Write-Host "`nWaiting for IP assignment..." -ForegroundColor Yellow
              Start-Sleep -Seconds 10
              
              $status = & $tailscalePath status 2>&1
              Write-Host "Status: $status" -ForegroundColor Gray
              
              $ip = & $tailscalePath ip -4 2>&1
              if ($ip -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                  Write-Host "‚úÖ Tailscale IP assigned: $ip" -ForegroundColor Green
              } else {
                  Write-Host "‚ùå No valid IP assigned. Got: $ip" -ForegroundColor Red
                  exit 1
              }
              
          } catch {
              Write-Host "‚ùå Connection failed: $_" -ForegroundColor Red
              exit 1
          }

      - name: Test RDP Configuration
        run: |
          Write-Host "`nüñ•Ô∏è  Testing RDP configuration..." -ForegroundColor Cyan
          
          try {
              # Enable RDP
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              Write-Host "‚úÖ RDP enabled in registry" -ForegroundColor Green
              
              # Check RDP service
              $rdpService = Get-Service -Name TermService
              Write-Host "‚úÖ RDP Service status: $($rdpService.Status)" -ForegroundColor Green
              
              # Check firewall
              $rdpRules = Get-NetFirewallRule -DisplayGroup "Remote Desktop" -Enabled True
              Write-Host "‚úÖ RDP firewall rules: $($rdpRules.Count) enabled" -ForegroundColor Green
              
              # Test RDP port
              $listener = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
              if ($listener) {
                  Write-Host "‚úÖ RDP is listening on port 3389" -ForegroundColor Green
              } else {
                  Write-Host "‚ö†Ô∏è  RDP not listening on port 3389 yet" -ForegroundColor Yellow
              }
              
          } catch {
              Write-Host "‚ùå RDP configuration failed: $_" -ForegroundColor Red
              exit 1
          }

      - name: Summary
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "       ‚úÖ DIAGNOSTIC COMPLETE" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "All tests passed! Your setup should work." -ForegroundColor Green
          Write-Host ""
          Write-Host "Next steps:" -ForegroundColor White
          Write-Host "1. Run the 'RDP-Simple' workflow" -ForegroundColor Gray
          Write-Host "2. Wait for Tailscale IP to be displayed" -ForegroundColor Gray
          Write-Host "3. Connect using Remote Desktop" -ForegroundColor Gray
          Write-Host ""
          Write-Host "========================================`n" -ForegroundColor Cyan
