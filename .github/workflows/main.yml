name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Detect Triggering Machine IP
        run: |
          Write-Host "Detecting the public IP of the machine that triggered this workflow..." -ForegroundColor Cyan
          
          # Get public IP from multiple sources for reliability
          $ipSources = @(
              "https://api.ipify.org",
              "https://ifconfig.me/ip",
              "https://icanhazip.com",
              "https://checkip.amazonaws.com"
          )
          
          $detectedIP = $null
          foreach ($source in $ipSources) {
              try {
                  $detectedIP = (Invoke-RestMethod -Uri $source -TimeoutSec 5).Trim()
                  if ($detectedIP -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      Write-Host "‚úÖ Detected IP: $detectedIP (from $source)" -ForegroundColor Green
                      break
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  Failed to get IP from $source, trying next..." -ForegroundColor Yellow
                  continue
              }
          }
          
          if (-not $detectedIP) {
              Write-Error "‚ùå Failed to detect public IP from all sources"
              exit 1
          }
          
          # Validate IP format
          if ($detectedIP -notmatch '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
              Write-Error "‚ùå Invalid IP format detected: $detectedIP"
              exit 1
          }
          
          echo "TRIGGER_IP=$detectedIP" >> $env:GITHUB_ENV
          Write-Host "üîí RDP will be restricted to IP: $detectedIP" -ForegroundColor Green
      - name: Configure Core RDP Settings and Firewall
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing RDP rules to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall delete rule name="RDP-Trigger-IP"
          netsh advfirewall firewall delete rule name="Block-RDP-Public"
          
          Write-Host "`nüîí Configuring Firewall Rules..." -ForegroundColor Cyan
          
          # Block all RDP connections by default (security first)
          netsh advfirewall firewall add rule name="Block-RDP-Public" `
            dir=in action=block protocol=TCP localport=3389 profile=public
          Write-Host "‚úÖ Blocked all public RDP connections" -ForegroundColor Green
          
          # Allow RDP from Tailscale network (100.64.0.0/10 is Tailscale's CGNAT range)
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389 `
            remoteip=100.64.0.0/10 profile=any
          Write-Host "‚úÖ Allowed RDP from Tailscale network (100.64.0.0/10)" -ForegroundColor Green
          
          # Allow RDP from the triggering machine's IP
          if (-not [string]::IsNullOrWhiteSpace($env:TRIGGER_IP)) {
              netsh advfirewall firewall add rule name="RDP-Trigger-IP" `
                dir=in action=allow protocol=TCP localport=3389 `
                remoteip=$env:TRIGGER_IP profile=any
              Write-Host "‚úÖ Allowed RDP from triggering machine: $env:TRIGGER_IP" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è  Warning: TRIGGER_IP not set, skipping IP-specific rule" -ForegroundColor Yellow
          }
          
          Write-Host "`nüîí Firewall Summary:" -ForegroundColor Cyan
          Write-Host "   - Blocked: All public internet" -ForegroundColor Red
          Write-Host "   - Allowed: Tailscale network (100.64.0.0/10)" -ForegroundColor Green
          Write-Host "   - Allowed: Your IP ($env:TRIGGER_IP)" -ForegroundColor Green
          Write-Host ""

          # Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ Remote Desktop service restarted" -ForegroundColor Green

      - name: Create RDP User with Static Credentials
        run: |
          # Use static credentials from GitHub Secrets
          $username = "${{ secrets.RDP_USERNAME }}"
          $password = "${{ secrets.RDP_PASSWORD }}"
          
          # Validate that secrets are set
          if ([string]::IsNullOrWhiteSpace($username) -or [string]::IsNullOrWhiteSpace($password)) {
              Write-Error "RDP_USERNAME or RDP_PASSWORD secret not set in GitHub repository"
              exit 1
          }
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Check if user already exists and remove it
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $username -Force
          }
          
          # Create new user with static credentials
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          echo "RDP_CREDS=User: $username | Password: ********" >> $env:GITHUB_ENV
          echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name $username)) {
              Write-Error "User creation failed"
              exit 1
          }
          
          Write-Host "User '$username' created successfully with static credentials"

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          Write-Host "`nüîó Connecting to Tailscale..." -ForegroundColor Cyan
          
          # Check if Tailscale is installed
          if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
              Write-Error "‚ùå Tailscale executable not found. Installation may have failed."
              exit 1
          }
          
          Write-Host "‚úÖ Tailscale executable found" -ForegroundColor Green
          
          # Bring up Tailscale with the provided auth key and set a unique hostname
          Write-Host "Authenticating with Tailscale..." -ForegroundColor Yellow
          
          try {
              $output = & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID 2>&1
              Write-Host "Tailscale up command output: $output" -ForegroundColor Gray
          } catch {
              Write-Error "‚ùå Failed to run Tailscale up command: $_"
              exit 1
          }
          
          # Wait a bit for Tailscale to initialize
          Write-Host "Waiting for Tailscale to initialize..." -ForegroundColor Yellow
          Start-Sleep -Seconds 10
          
          # Check Tailscale status
          Write-Host "`nChecking Tailscale status..." -ForegroundColor Yellow
          $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>&1
          Write-Host "Status: $status" -ForegroundColor Gray
          
          # Wait for Tailscale to assign an IP (increased retries and wait time)
          Write-Host "`nWaiting for IP assignment..." -ForegroundColor Yellow
          $tsIP = $null
          $retries = 0
          $maxRetries = 20  # Increased from 10
          
          while (-not $tsIP -and $retries -lt $maxRetries) {
              $retries++
              Write-Host "Attempt $retries/$maxRetries..." -ForegroundColor Gray
              
              try {
                  $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1) | Out-String
                  $tsIP = $tsIP.Trim()
                  
                  if ($tsIP -and $tsIP -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      Write-Host "‚úÖ IP detected: $tsIP" -ForegroundColor Green
                      break
                  } else {
                      Write-Host "‚è≥ No valid IP yet (got: '$tsIP')" -ForegroundColor Yellow
                      $tsIP = $null
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  Error getting IP: $_" -ForegroundColor Yellow
              }
              
              Start-Sleep -Seconds 10  # Increased from 5
          }
          
          if (-not $tsIP) {
              Write-Host "`n‚ùå TROUBLESHOOTING INFO:" -ForegroundColor Red
              Write-Host "Tailscale Status:" -ForegroundColor Yellow
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              Write-Host "`nTailscale Version:" -ForegroundColor Yellow
              & "$env:ProgramFiles\Tailscale\tailscale.exe" version
              Write-Host "`nNetwork Interfaces:" -ForegroundColor Yellow
              Get-NetIPAddress | Format-Table -AutoSize
              
              Write-Error "‚ùå Tailscale IP not assigned after $maxRetries attempts. Check your TAILSCALE_AUTH_KEY secret."
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "`n‚úÖ Tailscale connected successfully!" -ForegroundColor Green
          Write-Host "üìç Tailscale IP: $tsIP" -ForegroundColor Cyan
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "       RDP ACCESS INFORMATION" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Tailscale IP: $env:TAILSCALE_IP" -ForegroundColor Green
          Write-Host "Username: $env:RDP_USERNAME" -ForegroundColor Green
          Write-Host "Password: (Check GitHub Secrets - RDP_PASSWORD)" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "üîí Firewall Protection:" -ForegroundColor Cyan
          Write-Host "   ‚úÖ Allowed from Tailscale network" -ForegroundColor Green
          Write-Host "   ‚úÖ Allowed from your IP: $env:TRIGGER_IP" -ForegroundColor Green
          Write-Host "   ‚ùå Blocked from all other IPs" -ForegroundColor Red
          Write-Host ""
          Write-Host "========================================`n" -ForegroundColor Cyan
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
