name: RDP

on:
  workflow_dispatch:
    inputs:
      restore_session:
        description: 'Restore from previous session?'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      storage_backend:
        description: 'Persistent storage backend'
        required: true
        default: 'github-artifacts'
        type: choice
        options:
          - 'github-artifacts'
          - 'google-drive'
          - 'onedrive'
          - 'none'

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Detect Triggering Machine IP
        run: |
          Write-Host "Detecting the public IP of the machine that triggered this workflow..." -ForegroundColor Cyan
          
          # Get public IP from multiple sources for reliability
          $ipSources = @(
              "https://api.ipify.org",
              "https://ifconfig.me/ip",
              "https://icanhazip.com",
              "https://checkip.amazonaws.com"
          )
          
          $detectedIP = $null
          foreach ($source in $ipSources) {
              try {
                  $detectedIP = (Invoke-RestMethod -Uri $source -TimeoutSec 5).Trim()
                  if ($detectedIP -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      Write-Host "‚úÖ Detected IP: $detectedIP (from $source)" -ForegroundColor Green
                      break
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  Failed to get IP from $source, trying next..." -ForegroundColor Yellow
                  continue
              }
          }
          
          if (-not $detectedIP) {
              Write-Error "‚ùå Failed to detect public IP from all sources"
              exit 1
          }
          
          # Validate IP format
          if ($detectedIP -notmatch '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
              Write-Error "‚ùå Invalid IP format detected: $detectedIP"
              exit 1
          }
          
          echo "TRIGGER_IP=$detectedIP" >> $env:GITHUB_ENV
          Write-Host "üîí RDP will be restricted to IP: $detectedIP" -ForegroundColor Green

      - name: Restore Previous Session
        if: inputs.restore_session == 'yes' && inputs.storage_backend != 'none'
        run: |
          Write-Host "`nüì¶ Restoring previous session data..." -ForegroundColor Cyan
          
          $storageBackend = "${{ inputs.storage_backend }}"
          $restorePath = "$env:USERPROFILE\RDPSession"
          
          if ($storageBackend -eq "github-artifacts") {
              Write-Host "üîç Checking for previous session artifacts..." -ForegroundColor Yellow
              
              # Download the latest session backup artifact
              # Note: This requires the GitHub CLI or API token
              try {
                  # Create restore directory
                  New-Item -ItemType Directory -Path $restorePath -Force | Out-Null
                  
                  Write-Host "‚ö†Ô∏è  GitHub Artifacts restore requires manual setup" -ForegroundColor Yellow
                  Write-Host "   To enable: Add GITHUB_TOKEN to secrets and use actions/download-artifact" -ForegroundColor Gray
                  Write-Host "   For now, starting with fresh session..." -ForegroundColor Gray
              } catch {
                  Write-Host "‚ö†Ô∏è  Could not restore from artifacts: $_" -ForegroundColor Yellow
              }
          }
          elseif ($storageBackend -eq "google-drive") {
              Write-Host "‚òÅÔ∏è  Google Drive sync selected" -ForegroundColor Cyan
              
              # Install rclone for cloud storage
              try {
                  Write-Host "Installing rclone..." -ForegroundColor Yellow
                  choco install rclone -y --no-progress
                  
                  if ("${{ secrets.RCLONE_CONFIG }}" -ne "") {
                      # Restore rclone config from secret
                      $rcloneConfigPath = "$env:APPDATA\rclone\rclone.conf"
                      New-Item -ItemType Directory -Path (Split-Path $rcloneConfigPath) -Force | Out-Null
                      "${{ secrets.RCLONE_CONFIG }}" | Out-File -FilePath $rcloneConfigPath -Encoding UTF8
                      
                      Write-Host "‚úÖ Rclone configured" -ForegroundColor Green
                      Write-Host "üì• Syncing from Google Drive..." -ForegroundColor Cyan
                      
                      # Sync Desktop, Documents, Downloads
                      rclone sync "gdrive:RDP-Backup/Desktop" "$env:USERPROFILE\Desktop" -v
                      rclone sync "gdrive:RDP-Backup/Documents" "$env:USERPROFILE\Documents" -v
                      rclone sync "gdrive:RDP-Backup/Downloads" "$env:USERPROFILE\Downloads" -v
                      
                      Write-Host "‚úÖ Files restored from Google Drive" -ForegroundColor Green
                  } else {
                      Write-Host "‚ö†Ô∏è  RCLONE_CONFIG secret not set. Skipping cloud sync." -ForegroundColor Yellow
                      Write-Host "   See SETUP.md for rclone configuration instructions" -ForegroundColor Gray
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  Google Drive sync failed: $_" -ForegroundColor Yellow
              }
          }
          elseif ($storageBackend -eq "onedrive") {
              Write-Host "‚òÅÔ∏è  OneDrive sync selected" -ForegroundColor Cyan
              
              try {
                  Write-Host "Installing rclone..." -ForegroundColor Yellow
                  choco install rclone -y --no-progress
                  
                  if ("${{ secrets.RCLONE_CONFIG }}" -ne "") {
                      $rcloneConfigPath = "$env:APPDATA\rclone\rclone.conf"
                      New-Item -ItemType Directory -Path (Split-Path $rcloneConfigPath) -Force | Out-Null
                      "${{ secrets.RCLONE_CONFIG }}" | Out-File -FilePath $rcloneConfigPath -Encoding UTF8
                      
                      Write-Host "‚úÖ Rclone configured" -ForegroundColor Green
                      Write-Host "üì• Syncing from OneDrive..." -ForegroundColor Cyan
                      
                      rclone sync "onedrive:RDP-Backup/Desktop" "$env:USERPROFILE\Desktop" -v
                      rclone sync "onedrive:RDP-Backup/Documents" "$env:USERPROFILE\Documents" -v
                      rclone sync "onedrive:RDP-Backup/Downloads" "$env:USERPROFILE\Downloads" -v
                      
                      Write-Host "‚úÖ Files restored from OneDrive" -ForegroundColor Green
                  } else {
                      Write-Host "‚ö†Ô∏è  RCLONE_CONFIG secret not set. Skipping cloud sync." -ForegroundColor Yellow
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  OneDrive sync failed: $_" -ForegroundColor Yellow
              }
          }
          
          Write-Host "‚úÖ Session restore complete`n" -ForegroundColor Green

      - name: Configure Core RDP Settings and Firewall
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing RDP rules to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall delete rule name="RDP-Trigger-IP"
          netsh advfirewall firewall delete rule name="Block-RDP-Public"
          
          Write-Host "`nüîí Configuring Firewall Rules..." -ForegroundColor Cyan
          
          # Block all RDP connections by default (security first)
          netsh advfirewall firewall add rule name="Block-RDP-Public" `
            dir=in action=block protocol=TCP localport=3389 profile=public
          Write-Host "‚úÖ Blocked all public RDP connections" -ForegroundColor Green
          
          # Allow RDP from Tailscale network (100.64.0.0/10 is Tailscale's CGNAT range)
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389 `
            remoteip=100.64.0.0/10 profile=any
          Write-Host "‚úÖ Allowed RDP from Tailscale network (100.64.0.0/10)" -ForegroundColor Green
          
          # Allow RDP from the triggering machine's IP
          if (-not [string]::IsNullOrWhiteSpace($env:TRIGGER_IP)) {
              netsh advfirewall firewall add rule name="RDP-Trigger-IP" `
                dir=in action=allow protocol=TCP localport=3389 `
                remoteip=$env:TRIGGER_IP profile=any
              Write-Host "‚úÖ Allowed RDP from triggering machine: $env:TRIGGER_IP" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è  Warning: TRIGGER_IP not set, skipping IP-specific rule" -ForegroundColor Yellow
          }
          
          Write-Host "`nüîí Firewall Summary:" -ForegroundColor Cyan
          Write-Host "   - Blocked: All public internet" -ForegroundColor Red
          Write-Host "   - Allowed: Tailscale network (100.64.0.0/10)" -ForegroundColor Green
          Write-Host "   - Allowed: Your IP ($env:TRIGGER_IP)" -ForegroundColor Green
          Write-Host ""

          # Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ Remote Desktop service restarted" -ForegroundColor Green

      - name: Create RDP User with Static Credentials
        run: |
          # Use static credentials from GitHub Secrets
          $username = "${{ secrets.RDP_USERNAME }}"
          $password = "${{ secrets.RDP_PASSWORD }}"
          
          # Validate that secrets are set
          if ([string]::IsNullOrWhiteSpace($username) -or [string]::IsNullOrWhiteSpace($password)) {
              Write-Error "RDP_USERNAME or RDP_PASSWORD secret not set in GitHub repository"
              exit 1
          }
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Check if user already exists and remove it
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $username -Force
          }
          
          # Create new user with static credentials
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          echo "RDP_CREDS=User: $username | Password: ********" >> $env:GITHUB_ENV
          echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name $username)) {
              Write-Error "User creation failed"
              exit 1
          }
          
          Write-Host "User '$username' created successfully with static credentials"

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          Write-Host "`nüîó Connecting to Tailscale..." -ForegroundColor Cyan
          
          # Check if Tailscale is installed
          if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
              Write-Error "‚ùå Tailscale executable not found. Installation may have failed."
              exit 1
          }
          
          Write-Host "‚úÖ Tailscale executable found" -ForegroundColor Green
          
          # Bring up Tailscale with the provided auth key and set a unique hostname
          Write-Host "Authenticating with Tailscale..." -ForegroundColor Yellow
          
          try {
              $output = & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID 2>&1
              Write-Host "Tailscale up command output: $output" -ForegroundColor Gray
          } catch {
              Write-Error "‚ùå Failed to run Tailscale up command: $_"
              exit 1
          }
          
          # Wait a bit for Tailscale to initialize
          Write-Host "Waiting for Tailscale to initialize..." -ForegroundColor Yellow
          Start-Sleep -Seconds 10
          
          # Check Tailscale status
          Write-Host "`nChecking Tailscale status..." -ForegroundColor Yellow
          $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>&1
          Write-Host "Status: $status" -ForegroundColor Gray
          
          # Wait for Tailscale to assign an IP (increased retries and wait time)
          Write-Host "`nWaiting for IP assignment..." -ForegroundColor Yellow
          $tsIP = $null
          $retries = 0
          $maxRetries = 20  # Increased from 10
          
          while (-not $tsIP -and $retries -lt $maxRetries) {
              $retries++
              Write-Host "Attempt $retries/$maxRetries..." -ForegroundColor Gray
              
              try {
                  $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1) | Out-String
                  $tsIP = $tsIP.Trim()
                  
                  if ($tsIP -and $tsIP -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      Write-Host "‚úÖ IP detected: $tsIP" -ForegroundColor Green
                      break
                  } else {
                      Write-Host "‚è≥ No valid IP yet (got: '$tsIP')" -ForegroundColor Yellow
                      $tsIP = $null
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  Error getting IP: $_" -ForegroundColor Yellow
              }
              
              Start-Sleep -Seconds 10  # Increased from 5
          }
          
          if (-not $tsIP) {
              Write-Host "`n‚ùå TROUBLESHOOTING INFO:" -ForegroundColor Red
              Write-Host "Tailscale Status:" -ForegroundColor Yellow
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              Write-Host "`nTailscale Version:" -ForegroundColor Yellow
              & "$env:ProgramFiles\Tailscale\tailscale.exe" version
              Write-Host "`nNetwork Interfaces:" -ForegroundColor Yellow
              Get-NetIPAddress | Format-Table -AutoSize
              
              Write-Error "‚ùå Tailscale IP not assigned after $maxRetries attempts. Check your TAILSCALE_AUTH_KEY secret."
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "`n‚úÖ Tailscale connected successfully!" -ForegroundColor Green
          Write-Host "üìç Tailscale IP: $tsIP" -ForegroundColor Cyan
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "       RDP ACCESS INFORMATION" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Tailscale IP: $env:TAILSCALE_IP" -ForegroundColor Green
          Write-Host "Username: $env:RDP_USERNAME" -ForegroundColor Green
          Write-Host "Password: (Check GitHub Secrets - RDP_PASSWORD)" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "üîí Firewall Protection:" -ForegroundColor Cyan
          Write-Host "   ‚úÖ Allowed from Tailscale network" -ForegroundColor Green
          Write-Host "   ‚úÖ Allowed from your IP: $env:TRIGGER_IP" -ForegroundColor Green
          Write-Host "   ‚ùå Blocked from all other IPs" -ForegroundColor Red
          Write-Host ""
          Write-Host "========================================`n" -ForegroundColor Cyan
          
          # Keep runner active and perform periodic backups
          $backupInterval = 1800  # 30 minutes in seconds
          $lastBackup = Get-Date
          $storageBackend = "${{ inputs.storage_backend }}"
          
          while ($true) {
              $currentTime = Get-Date
              $timeSinceBackup = ($currentTime - $lastBackup).TotalSeconds
              
              Write-Host "[$currentTime] RDP Active - Use Ctrl+C in workflow to terminate" -ForegroundColor Green
              
              # Perform periodic backup if enabled
              if ($storageBackend -ne "none" -and $timeSinceBackup -ge $backupInterval) {
                  Write-Host "`nüíæ Performing periodic backup..." -ForegroundColor Cyan
                  
                  if ($storageBackend -eq "google-drive" -or $storageBackend -eq "onedrive") {
                      try {
                          $remoteName = if ($storageBackend -eq "google-drive") { "gdrive" } else { "onedrive" }
                          
                          Write-Host "üì§ Syncing to $storageBackend..." -ForegroundColor Yellow
                          rclone sync "$env:USERPROFILE\Desktop" "${remoteName}:RDP-Backup/Desktop" -v --exclude "desktop.ini"
                          rclone sync "$env:USERPROFILE\Documents" "${remoteName}:RDP-Backup/Documents" -v --exclude "desktop.ini"
                          rclone sync "$env:USERPROFILE\Downloads" "${remoteName}:RDP-Backup/Downloads" -v --exclude "desktop.ini"
                          
                          Write-Host "‚úÖ Backup completed at $currentTime" -ForegroundColor Green
                          $lastBackup = $currentTime
                      } catch {
                          Write-Host "‚ö†Ô∏è  Backup failed: $_" -ForegroundColor Yellow
                      }
                  }
                  elseif ($storageBackend -eq "github-artifacts") {
                      Write-Host "‚ÑπÔ∏è  GitHub Artifacts backup on shutdown only" -ForegroundColor Gray
                      $lastBackup = $currentTime
                  }
              }
              
              Start-Sleep -Seconds 300
          }

      - name: Backup Session on Shutdown
        if: always() && inputs.storage_backend != 'none'
        run: |
          Write-Host "`nüíæ Performing final session backup..." -ForegroundColor Cyan
          
          $storageBackend = "${{ inputs.storage_backend }}"
          
          if ($storageBackend -eq "google-drive" -or $storageBackend -eq "onedrive") {
              try {
                  $remoteName = if ($storageBackend -eq "google-drive") { "gdrive" } else { "onedrive" }
                  
                  if ("${{ secrets.RCLONE_CONFIG }}" -ne "") {
                      Write-Host "üì§ Final sync to $storageBackend..." -ForegroundColor Yellow
                      
                      rclone sync "$env:USERPROFILE\Desktop" "${remoteName}:RDP-Backup/Desktop" -v --exclude "desktop.ini"
                      rclone sync "$env:USERPROFILE\Documents" "${remoteName}:RDP-Backup/Documents" -v --exclude "desktop.ini"
                      rclone sync "$env:USERPROFILE\Downloads" "${remoteName}:RDP-Backup/Downloads" -v --exclude "desktop.ini"
                      
                      Write-Host "‚úÖ Final backup completed successfully" -ForegroundColor Green
                  } else {
                      Write-Host "‚ö†Ô∏è  RCLONE_CONFIG not set, skipping backup" -ForegroundColor Yellow
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è  Final backup failed: $_" -ForegroundColor Yellow
              }
          }
          elseif ($storageBackend -eq "github-artifacts") {
              Write-Host "üì¶ Creating GitHub Artifacts backup..." -ForegroundColor Yellow
              
              # Create a compressed backup
              $backupPath = "$env:TEMP\rdp-session-backup.zip"
              
              try {
                  Compress-Archive -Path "$env:USERPROFILE\Desktop","$env:USERPROFILE\Documents","$env:USERPROFILE\Downloads" `
                                   -DestinationPath $backupPath -Force
                  
                  Write-Host "‚úÖ Backup archive created: $backupPath" -ForegroundColor Green
                  Write-Host "‚ÑπÔ∏è  To enable artifact upload, add actions/upload-artifact step" -ForegroundColor Gray
              } catch {
                  Write-Host "‚ö†Ô∏è  Failed to create backup archive: $_" -ForegroundColor Yellow
              }
          }
          
          Write-Host "`n‚úÖ Session backup complete" -ForegroundColor Green

